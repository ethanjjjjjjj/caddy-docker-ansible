---
# tasks file for roles/caddy-build-and-run-docker
- name: Pull caddy build image
  community.docker.docker_image:
    name: caddy:builder
    source: pull
- name: Create build dir
  ansible.builtin.file:
    path: /root/dockerbuild
    state: directory
    mode: u=rwx,g,o
- name: Template dockerfile
  ansible.builtin.template:
    src: "{{ role_path }}/templates/Dockerfile.j2"
    dest: /root/dockerbuild/Dockerfile
    mode: u=rw,g,o
- name: Build image with modules
  community.docker.docker_image_build:
    name: "{{ image_name }}"
    tag: latest
    dockerfile: Dockerfile
    path: /root/dockerbuild/
- name: Run caddy container
  community.docker.docker_container:
    name: caddy
    image: "{{ image_name }}"
    network_mode: host
    restart_policy: "unless-stopped"
    env:
      cloudflare_api_key: "{{ cloudflare_key }}"
    state: present
- name: Copy Caddyfile to host
  ansible.builtin.template:
    src: "{{caddyfile}}"
    dest: /root/Caddyfile
    mode: u=rw,g,o
- name: Copy Caddyfile
  community.docker.docker_container_copy_into:
    container: caddy
    path: /root/Caddyfile
    container_path: /etc/caddy/Caddyfile
    owner_id: 0
    group_id: 0
  register: copy_config_result
  notify: Restart container if config changed
